# 模型验证与风险管理

## 概述

本模块提供了完整的模型验证与风险管理功能，包括样本外测试、压力测试和模型置信度评估。

## 功能特性

### 1. 样本外测试（Walk-forward Analysis）

使用滚动窗口回测避免过拟合，模拟真实交易环境。

**配置参数：**
- `initial_train_size`: 初始训练样本数（默认252条，约1年）
- `test_size`: 测试样本数（默认30条，约1个月）
- `step_size`: 滚动步长（默认15条，约半个月）
- `min_train_size`: 最小训练样本数（默认100条）

**关键指标：**
- RMSE（均方根误差）
- MAE（平均绝对误差）
- R²（决定系数）
- **方向准确率（Directional Accuracy）**：最重要指标，≥65%为优秀

### 2. 市场环境分析

区分不同市场环境下的模型表现差异。

**市场类型：**
- 趋势市（20日涨跌幅 > 10%）
- 震荡市（20日涨跌幅 ≤ 10%）

**分析维度：**
- 各环境下的RMSE、MAE
- 各环境下的方向准确率

### 3. 压力测试

模拟极端市场情景，评估模型抗风险能力。

#### 3.1 中国需求断崖

- **情景**：地产新开工下降30%
- **需求弹性**：0.7（铜价对需求的弹性）
- **价格冲击**：-21%
- **风险等级**：极高风险

#### 3.2 美元流动性危机

- **参考情景1**：2020年3月新冠疫情恐慌
  - 美元指数飙升：+8%
  - 铜价下跌：-30%
  - 美元-铜价相关系数：-0.7
  
- **参考情景2**：2022年9月激进加息
  - 美元指数飙升：+5%
  - 铜价下跌：-20%

#### 3.3 供应端黑天鹅

- **智利地震**：
  - 供应影响：-7%
  - 供应弹性：2.0
  - 价格冲击：+14%
  
- **巴拿马运河干旱**：
  - 供应影响：-3%
  - 供应弹性：1.5
  - 价格冲击：+4.5%

### 4. 模型置信度分析

综合评估模型预测能力。

**关键指标：**
- **R²（解释力）**：>0.6说明解释力强，但不保证预测力
- **方向准确率**：≥65%为优秀，≥55%为良好
- **归一化RMSE**：越小越好
- **最大误差**：最大预测误差
- **综合置信度评分**：0-100分

**评分权重：**
- 方向准确率：40%（最重要）
- R²：30%
- 归一化RMSE：20%
- 误差稳定性：10%

### 5. 风险管理

提供实用的风险管理建议和工具。

#### 5.1 仓位管理

基于凯利公式改进版计算建议仓位大小：

```
仓位比例 = 基础2% × 置信度因子 × 波动率调整因子
最大仓位限制：10%
```

#### 5.2 止损止盈

- **单日最大止损**：3%（铜价单日波动可达5%）
- **目标止盈**：5%
- **动态调整**：根据波动率动态调整止损宽度

#### 5.3 风险监控

实时监控以下指标：
- 当前盈亏百分比
- 最大回撤
- 止损触发状态
- 止盈触发状态

## 使用方法

### 命令行使用

```bash
# 验证XGBoost模型
python main.py --validate --validate-model xgboost

# 验证宏观因子模型
python main.py --validate --validate-model macro

# 验证基本面模型
python main.py --validate --validate-model fundamental
```

### Python API使用

```python
from main import CopperPredictionSystem

# 创建系统
system = CopperPredictionSystem(data_source='auto')

# 训练模型
system.train_xgboost()
system.train_macro()
system.train_fundamental()

# 验证模型
results = system.validate_model('macro')

# 查看验证结果
print(results['walk_forward'])      # 滚动窗口回测结果
print(results['regime_analysis'])    # 市场环境分析
print(results['stress_test'])        # 压力测试结果
print(results['confidence'])          # 模型置信度
print(results['risk_report'])        # 风险报告
```

### 自定义配置

```python
from models.model_validation import (
    ModelValidator, WalkForwardConfig, 
    StressTestConfig, RiskMetricsConfig
)

# 自定义滚动窗口配置
walk_forward_config = WalkForwardConfig(
    initial_train_size=365,  # 1年
    test_size=60,            # 2个月
    step_size=30             # 1个月
)

# 自定义压力测试配置
stress_test_config = StressTestConfig(
    china_demand_drop=-0.40,  # 需求下降40%
    usd_spike_scenario='2022-09'
)

# 自定义风险管理配置
risk_config = RiskMetricsConfig(
    directional_accuracy_threshold=0.70,  # 提高标准到70%
    stop_loss_pct=0.02,                  # 止损2%
    take_profit_pct=0.08                  # 止盈8%
)

# 创建验证器
validator = ModelValidator(
    walk_forward_config=walk_forward_config,
    stress_test_config=stress_test_config,
    risk_metrics_config=risk_config
)

# 运行验证
results = validator.validate(model, data, features)
```

## 输出说明

### 验证报告文件

运行验证后会生成以下文件：
- `validation_report_{model_type}_{timestamp}.txt`：风险管理报告

### 报告内容

```
============================================================
🚨 风险管理报告
============================================================

【模型置信度】
  R² (解释力): 0.8765
  方向准确率: 65.23%
    ✓ 优秀: 方向准确率达到优秀标准(≥65%)

【压力测试】
  最坏情景: 综合最坏情景
  潜在最大损失: 21.00%
    🚨 极高风险: 必须严格控制仓位

【风险管理建议】
  1. 单日最大止损: 3.0%
     (铜价单日波动可达5%,必须设置止损)
  2. 目标止盈: 5.0%
  3. 建议最大仓位: 10% (根据模型置信度调整)
  4. 分批建仓,分散风险
```

## 重要提示

### R²的局限性

R² > 0.6 仅说明模型解释力强，**不保证预测力**。实际交易中应更关注：
- 方向准确率（能否正确判断涨跌方向）
- 最大回撤（最大损失控制）
- 实际盈亏（真实交易结果）

### 铜价波动特性

- 单日最大波动可达5%
- 极端情况下波动可能超过10%
- 必须设置止损逻辑
- 建议单笔仓位不超过10%

### 压力测试参考

- **中国需求断崖**：最坏情况下价格可能下跌21%
- **美元流动性危机**：价格可能下跌5-30%
- **供应端黑天鹅**：价格可能上涨4-14%

## 最佳实践

1. **多模型组合**：不要依赖单一模型，结合技术分析、宏观因子和基本面模型
2. **严格止损**：必须设置止损，铜价单日波动可达5%
3. **动态仓位**：根据模型置信度和市场波动调整仓位
4. **分批建仓**：降低建仓风险，提高容错率
5. **持续验证**：定期进行滚动窗口回测，监控模型性能衰减

## 示例输出

```bash
============================================================
🔍 模型验证与风险管理
============================================================

【1. 样本外测试】
============================================================
📊 滚动窗口回测 (Walk-forward Analysis)
============================================================
  Fold 1: 训练252条 | 预测30条 | MAE=3120.45
  Fold 2: 训练267条 | 预测30条 | MAE=2987.23
  Fold 3: 训练282条 | 预测30条 | MAE=3105.67

✓ 滚动窗口回测完成
  总预测数: 90
  RMSE: 3421.56
  MAE: 3062.45
  R²: 0.8234
  方向准确率: 67.78%

【2. 市场环境分析】
============================================================
📈 市场环境分析
============================================================

TRENDING市场 (34个样本):
  RMSE: 2876.45
  MAE: 2654.32
  方向准确率: 75.32%

SIDEWAYS市场 (56个样本):
  RMSE: 3721.45
  MAE: 3312.23
  方向准确率: 61.25%

【3. 压力测试】
============================================================
⚠️ 压力测试: 中国需求断崖
============================================================
情景: 地产新开工下降-30%
  基础预测价格: ¥103,920.00
  需求弹性系数: 0.7
  价格冲击: -21.00%
  冲击后价格: ¥82,096.80
  风险等级: 极高风险

【4. 模型置信度】
============================================================
📊 模型置信度分析
============================================================
  R² (解释力): 0.8234
    → 解释力较强
  方向准确率: 67.78%
    → 优秀 (≥65%)
  RMSE: 3421.56 (归一化: 3.29%)
  MAE: 3062.45
  最大误差: 8923.45 (8.59%)
  误差标准差: 1234.56

  综合置信度评分: 85.67/100
    → 置信度: 高

【5. 风险管理】
============================================================
🚨 风险管理报告
============================================================
```
